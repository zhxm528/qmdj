# “补齐基础盘面结构 → 输出结构表”的标准。
- 按**输入→计算→输出表结构**来写，最终输出一张“盘面结构总表”。



## 0) 输入（你必须先有这些）

* 四柱：年柱、月柱、日柱、时柱（每柱=天干+地支）
* 日主：日干（作为十神参照）
* 地支藏干表（固定字典）
* 天干五行阴阳表（固定字典）
* 五合、六合、三合、三会、冲、刑、害、破、干克、干合规则表（固定字典）



## 1) 十神表（以日干为基准）

**目的：** 给每一个“干、藏干”打上“与日主的关系标签”。

### 1.1 十神判定规则（程序最稳写法）

对任意一个“对照干 X”，先取：

* `sameElement?`（五行是否同）
* `sameYinYang?`（阴阳是否同）
* `controls?`（X 克 日主？日主克 X？X 生 日主？日主生 X？）

得到十神：

* 同五行：

  * 同阴阳：比肩
  * 异阴阳：劫财
* 生我（X 生日主）：印

  * 同阴阳：偏印
  * 异阴阳：正印
* 我生（日主生 X）：食伤

  * 同阴阳：食神
  * 异阴阳：伤官
* 我克（日主克 X）：财

  * 同阴阳：偏财
  * 异阴阳：正财
* 克我（X 克日主）：官杀

  * 同阴阳：七杀
  * 异阴阳：正官

### 1.2 输出（十神结构表）

* 四柱天干十神：年干、月干、日干（标“日主”）、时干
* 四柱地支藏干十神：每个地支的藏干分别标十神（并标主气/中气/余气）



## 2) 藏干表（地支拆解）

**目的：** 把“地支里面的真实五行来源”显性化。

### 2.1 输出（每柱地支的藏干列表）

每个地支输出类似：

* `月支=寅：藏干[甲(主气), 丙(中气), 戊(余气)]`
  并为每个藏干附上：
* 五行、阴阳、十神



## 3) 根（通根）表：日主是否“有根、根在哪”

**目的：** 强弱判断前，先把“日主有没有落地支根”算清。

### 3.1 通根判定（最实用的版本）

对每个地支：

* 若其藏干中包含“与日主同五行的天干”（例如日主甲木，则地支藏干出现甲/乙都算木根）
* 记录根的强弱（常用分级）：

  * **本气根（主气）**：最强
  * **中气根**：次强
  * **余气根**：较弱
* 再记录根的位置：年/月/日/时支（位置影响很大：月支根权重大）

### 3.2 输出（根/通根表）

* `root_count_total`
* `roots`: [{pillar:"月支", branch:"寅", hidden:"甲", strength:"本气根"}, …]
* 可加一个汇总：日主根的“强/中/弱”数量



## 4) 透（透干）表：藏干有没有“透出来”

**目的：** 判断某五行/十神是“暗”还是“明”，以及结构是否清纯。

### 4.1 透干规则

对每个地支藏干 H：

* 若四柱天干中出现同名干（或同五行同类要不要算透，按你流派决定；**建议先用“同名干”算透最稳**）
* 则记为“透”，并记录透到哪个天干位（年干/月干/时干）

### 4.2 输出（透干表）

* `reveals`: [{branch_pillar:"月支", hidden:"甲", reveal_to:["年干"]}, …]
* `not_revealed_hidden`: 列出未透的关键藏干（常用于判断“暗财/暗官”等）



## 5) 合冲刑害破 + 干合干克：关系网表

**目的：** 把“盘中可引动结构变化的力学关系”一次性标注出来。

### 5.1 先做“地支关系”

在四柱地支集合 `{年支, 月支, 日支, 时支}` 中：

* 两两检测：

  * 六合
  * 六冲
  * 六害
  * 六破
* 再检测三合局、三会局（需要 3 个支同时存在）
* 再检测刑（常见：子卯刑、寅巳申三刑、丑未戌三刑、辰辰/午午/酉酉/亥亥自刑等，按你规则表）

输出要包含：

* 关系类型
* 涉及地支
* 若成局：成什么局、五行指向是什么
* 是否被冲破（例如三合刚成又被冲）

### 5.2 再做“天干关系”

在四柱天干集合 `{年干, 月干, 日干, 时干}` 中：

* 两两检测：

  * 天干五合（甲己、乙庚、丙辛、丁壬、戊癸）
  * 天干相克（按五行克）
  * 可选：相生（一般不单列也行，但程序做出来很方便）

输出要包含：

* 合/克发生在哪两个干位
* 是否被第三干介入（例如合而不化/合化条件不足——如果你要做高级版）



# 6) 最终“结构表”应该长什么样（推荐输出格式）

我建议你输出 3 张表 + 1 个关系网：

## 表A：四柱总览（每柱一行）

字段建议：

* `pillar`（年/月/日/时）
* `stem`（天干）
* `stem_element_yinyang`
* `stem_tenshen`（相对日主；日柱天干标“日主”）
* `branch`（地支）
* `branch_element`（地支主气五行，或你也可留空用藏干表表达）
* `hidden_stems`（列表：[{干, 主中余, 五行阴阳, 十神, 是否通根, 是否透干}, …]）

## 表B：十神汇总表

* 十神出现次数（含透干/藏干分开统计）
* 关键十神是否“透而有力”（例如官杀是否透、财是否透）

## 表C：根与透的汇总表

* `roots_summary`：本气根/中气根/余气根数量与位置
* `reveals_summary`：哪些藏干透到哪些干

## 网D：合冲刑害破/干合干克关系列表

* `branch_relations`: [{type:"冲", a:"子(年支)", b:"午(时支)"}, …]
* `stem_relations`: [{type:"合", a:"甲(年干)", b:"己(月干)"}, …]
* `special_structures`: [{type:"三合局", members:["申","子","辰"], element:"水"}, …]



## 7) 一个你可以直接照抄的“结构表模板（JSON骨架）”

```json
{
  "day_master": { "stem": "甲", "element": "木", "yinyang": "阳" },
  "pillars": [
    {
      "pillar": "year",
      "stem": { "char": "庚", "element": "金", "yinyang": "阳", "tenshen": "七杀" },
      "branch": {
        "char": "寅",
        "hidden": [
          { "char": "甲", "role": "主气", "element": "木", "yinyang": "阳", "tenshen": "比肩", "is_root": true, "reveal_to": ["day_stem"] },
          { "char": "丙", "role": "中气", "element": "火", "yinyang": "阳", "tenshen": "食神", "is_root": false, "reveal_to": [] },
          { "char": "戊", "role": "余气", "element": "土", "yinyang": "阳", "tenshen": "偏财", "is_root": false, "reveal_to": [] }
        ]
      }
    }
  ],
  "roots": {
    "summary": { "benqi": 1, "zhongqi": 0, "yuqi": 0 },
    "details": [
      { "location": "year_branch", "branch": "寅", "hidden": "甲", "strength": "本气根" }
    ]
  },
  "reveals": [
    { "from_branch": "寅", "hidden": "甲", "to_stems": ["day_stem"] }
  ],
  "relations": {
    "stems": [
      { "type": "合", "a": "甲(day)", "b": "己(month)" },
      { "type": "克", "a": "庚(year)", "b": "甲(day)" }
    ],
    "branches": [
      { "type": "冲", "a": "子(year)", "b": "午(month)" },
      { "type": "六合", "a": "寅(year)", "b": "亥(hour)" }
    ],
    "structures": [
      { "type": "三合局", "members": ["申","子","辰"], "element": "水", "is_complete": true }
    ]
  }
}
```



## 核心功能
- 前端页面：`/app/bazi/page.tsx`
- 步骤2程序：`/app/api/bazi/step2.ts`
- 数据库：`/md/database/2_qimen_pan.sql`
- 配置文件： `/lib/config.ts`
- 前端可在步骤1中调用此 地支藏干 API 获取地支藏干信息，并以表格形式展示。
