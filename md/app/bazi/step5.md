# 定结构：格局/成局/清纯与破格 → 输出：可能格局列表 + 取舍理由
- 做成**可追溯的候选列表**：每个候选格局都带**证据**与**否决/降级理由**，最后选一个“主结构”，其余留作“备选结构”。



## 1) 定格局的主轴：先从**月令**下手（格局第一权重）

### 1.1 取“月令之神”

* 先取**月支藏干**的**主气**（很多派以此为“月令之神”）
* 将该藏干与日主对照，得出其**十神属性**

  * 主气为官杀 → 候选：官杀格
  * 主气为财 → 候选：财格
  * 主气为食伤 → 候选：食伤格
  * 主气为印 → 候选：印格
  * 主气为比劫 → 候选：建禄/比劫格（有的派单列“建禄格/羊刃格”）

> **注意：杂气月（辰戌丑未）**别直接拍主气。建议改成“杂气格候选池”，再靠“透/根/得助”决定谁当家（见 2.2）。



## 2) 给每个候选格局打“成格分”（决定：真不真、强不强）

你要做的是一个“证据累加”的评分/打标签系统，方便输出“取舍理由”。

### 2.1 成格的三大硬证据（最常用、最好程序化）

对某个候选“格神”（例如官杀/财/食伤/印/比劫），看它是否：

1. **得令**：它对应五行在月令季节里是否旺相（你上一步就有旺相休囚死）
2. **有根**：在地支（尤其月支/日支）是否有同五行藏干支撑
3. **透干**：是否透到天干（尤其月干最关键，其次时干/年干）

> 实用规则：

* “得令 + 有根 + 透干” → **强成格**
* 只有其中 2 项 → **中成格**
* 只有 1 项 → **弱成格/仅为主题，不够当主结构**

### 2.2 杂气月（辰戌丑未）怎么选“主格神”

候选通常不止一个（比如丑藏癸辛己：印/官/财都可能）。
建议用这个顺序决胜：

* **透在月干者优先**
* 同时比较：**根在月支/日支者优先**
* 再比较：**季节旺相者优先**
* 若仍打平：看谁被冲合刑害破坏更少（稳定者胜）



## 3) “成局”（三合/三会/六合）是第二根主轴：它会改气势

格局是“十神结构”，成局是“地支气势”。两者都要列出来，并判断谁主导。

### 3.1 成局识别（建议你至少做这几类）

* **三会局**（寅卯辰=木会，巳午未=火会，申酉戌=金会，亥子丑=水会）

  > 通常气势最强（若齐全且不受重冲）
* **三合局**（申子辰水、亥卯未木、寅午戌火、巳酉丑金）
* **六合 / 半合**（用于加权，但通常不如三会三合主导）

### 3.2 成局什么时候“压过”月令格局？

满足任意一个，就要把它当成“候选主结构”：

* 成局**齐全**且至少一支在月令季节得势（或月支就在局内）
* 成局对应的五行**在天干有透**或在地支**根很深**
* 月令格神反而**不透/无根/被冲破**



## 4) 清纯 vs 破格：决定“格局能不能用”

你输出里必须有这两栏：**清纯度**与**破格点**。这是取舍的关键。

### 4.1 清纯（加分项）

对候选格局，满足越多越“清”：

* 格神**透而不杂**：同阵营透出集中（比如官格官星清透）
* 其他十神虽有，但处于**从属位置**（不抢主导权）
* 合冲刑害对格神影响小（格神不被冲散、不被合去）

### 4.2 常见破格/降格点（你可以做成规则表）

（不按某派绝对断语，只作为“风险标签/降级理由”）

* **官杀混杂**（正官七杀同透且无制化/无去留）
* **伤官见官**（伤官透而官亦透，且缺制化/调和）
* **财破印**（财强而印为结构关键，被冲克耗尽）
* **枭神夺食**（偏印强而食神为结构关键，被夺）
* **比劫夺财**（财为结构关键却比劫成势来夺）
* **格神被冲破/被合绊**（格神根在某支，却被强冲；或关键干被合走导致“用不上”）
* **身态不匹配**（格局需要日主承载，但你前一步判身弱/身强严重不适配）

  > 这条很关键：很多“看起来像某格”的盘，最后因为身态不匹配只能降级成“主题”。



## 5) 最终输出格式：可能格局列表 + 取舍理由（推荐结构）

你可以按“排序后的候选列表”输出，每个候选都带证据与否决点：

```json
{
  "candidates": [
    {
      "name": "官杀格",
      "strength_level": "强成格",
      "supporting_evidence": [
        "月令主气为官杀（来自月支主气藏干）",
        "官杀透于月干/时干（清透）",
        "官杀在地支有根（尤其月支/日支）",
        "地支成局/半局助官杀之五行"
      ],
      "purity": [
        "官星不混杂（或混杂但有明确制化）",
        "伤官不透或可制化"
      ],
      "break_or_risks": [
        "若见伤官透且官亦透 → 标记：伤官见官风险",
        "根所在支被冲 → 官格稳定性下降"
      ],
      "why_not_others": [
        "财虽多但不透/无根，难当主格",
        "成局不完整或被重冲，难主导气势"
      ]
    },
    {
      "name": "财格（备选）",
      "strength_level": "中成格",
      "supporting_evidence": ["…"],
      "break_or_risks": ["比劫夺财风险…"]
    }
  ],
  "primary_choice": "官杀格",
  "decision_summary": "以月令官杀为纲，透而有根，清纯度较高；其他结构要么不透要么被冲破，故降为主题/备选。"
}
```



## 6) 你用这套方法时的“底线原则”

* **先月令格神 → 再看透根旺相 → 再看成局能否改气 → 最后用清纯/破格做取舍**
* 你不是在“找唯一答案”，而是在“做一个可解释的排序决策”


## 核心功能
- 前端页面：`/app/bazi/page.tsx`
- 步骤5程序：`/app/api/bazi/step5.ts`
- 数据库：`/md/database/2_qimen_pan.sql`
- 配置文件： `/lib/config.ts`
- 重写后台程序，按上面规则生成代码定结构：格局/成局/清纯与破格 → 输出：可能格局列表 + 取舍理由。

