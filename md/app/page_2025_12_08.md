# 核心功能

## 文件位置

- **前端页面**：`/app/page.tsx`

---

## 涉及数据库表

### 数据库表结构文件

- `md/database/2_qimen_pan.sql` - 排盘结果表结构
- `md/database/8_agent.sql` - Agent会话记录表结构

### 关联的数据库表

- **`qimen_pan`** - 排盘结果表
- **`conversations`** - 对话表（会话主表）
- **`agent_records`** - 提问记录表（AI分析结果）

---

## 修改内容

### 1. 按钮功能调整

将原有的"排盘"按钮拆分为两个独立按钮：

- **"排盘"按钮**
  - 功能：排盘仅指"排地盘干""排天盘干""排地八神""排天八神""排九星""排八门""排空亡""排驿马""排寄宫"，不包括"问事"
  - 行为：排盘后回显排盘结果
  - 不调用 AI 分析接口

- **"看盘"按钮**
  - 功能：执行完整的看盘流程
  - 行为：
    - 将问事内容和排盘结果作为参数调用 AI API 接口
    - 回显 AI 分析看盘结果
    - 保存问事内容和 AI 分析结果到数据库

### 2. 页面布局调整

**显示顺序（从上至下）**：

1. **"排盘"按钮**
2. **看盘分析结果**
3. **"问事"文本框**
4. **"看盘"按钮**
5. 以下保持原页面内容布局

### 3. 数据存储功能

每次点击"看盘"按钮时：

- ✅ 保持原有调用 DeepSeek 分析看盘的功能
- ✅ 将回显的 AI 分析结果放在"问事"文本框上方
- ✅ 同时将问事内容和 AI 分析看盘内容存入数据库

### 4. AI 分析结果展示区域

**区域分为左右两侧布局**：

- **左侧（菜单栏）**
  - 显示每次对话的简要标题
  - 标题是根据问事内容，调用 DeepSeek API 接口总结归纳的简短标题
  - 点击标题可切换显示对应的分析结果

- **右侧（内容区）**
  - 显示 AI 看盘分析结果
  - 根据左侧选中的对话标题显示对应的分析内容
  - 按照数据创建的时间从新到旧，从上到下显示
  - 根据传统ai agent的显示模式："问题"+"回答"的布局形式显示每次问事和 AI 分析结果；

---

## 实现要点

### 数据库操作

- 每次"看盘"操作需要保存：（`/api/conversations/route.ts`）
  - 问事内容（原始提问 + 提炼后的结构化问题）
  - 排盘结果关联（`pan_id`）
  - AI 分析结果文本
  - 对话标题（自动生成）

### API 调用

- DeepSeek API 调用保持不变（`/api/kanpan`）
- 可能需要新增 API 用于：
  - 保存对话和提问记录
  - 获取用户的历史对话列表
  - 生成对话标题

### 用户体验

- 保持原有页面布局和交互逻辑
- 新增对话历史浏览功能
- 支持通过标题快速切换查看历史分析结果
