# Node.js「苹果机」游戏设计说明（非现金、娱乐版）

---

## 1. 项目简介

- **项目名称**：Fruit Apple Slot

---

## 2. 功能需求

### 2.1 玩家视角功能

1. 注册 / 登录
   - 支持邮箱 / 用户名 + 密码 或 匿名游客模式（可选）。
   - 登录后与玩家账户绑定虚拟金币余额。

2. 主页（大厅）
   - 显示当前金币余额。
   - 显示“开始游戏”或“进入苹果机”按钮。
   - 显示简单公告（例如：本游戏仅供娱乐，禁止用于赌博）。

3. 苹果机游戏界面
   - 显示 3×3 或 3×5 格子的水果图标：
     - 苹果、橙子、西瓜、葡萄、铃铛、BAR、7 等。
   - 下注区：
     - 可调节单线下注额（例如：1、5、10 金币）。
     - 可选择启用的线（line）数量（如 1、5、9 线）。
   - 控制按钮：
     - `Spin` / `开始`：发起一次转动。
     - `Max Bet`（可选）：一键最大下注。
     - `Auto Spin`（可选）：设置自动转动次数。
   - 结果展示：
     - 转轴滚动动画（前端实现）。
     - 停止后高亮中奖线。
     - 显示本局输赢情况：本次赢得金币数、当前余额。
   - 基础提示：
     - 公平随机提示。
     - 本游戏无任何真实货币收益。

4. 历史记录（前端展示）
   - 显示最近 N 局的结果（日期、下注额、赢得金币数）。
   - 可从后端分页拉取。

### 2.2 管理功能（后台面板）

1. 管理员登录系统。
2. 配置游戏参数：
   - 符号列表及权重（影响概率）。
   - 赔率表（paytable）。
   - 最小 / 最大单线下注额。
   - 最大总下注额（防止玩家“玩疯”）。
3. 查看统计数据：
   - 总局数、总下注额、总返奖额（RTP 粗略统计）。
   - 在线玩家数量。
4. 玩家管理：
   - 搜索玩家，查看他的局数记录。
   - 手动发放虚拟金币（例如活动奖励）。

---

## 3. 游戏规则与数学设计

### 3.1 盘面与线型

1. 盘面
   - 初版推荐：**3×3**（3 列转轴 × 3 行）
   - 后期可扩展为：3×5 或更多列。

2. 支付线（Lines）
   - 典型方案（3 行）：9 线
     1. 上中下水平线 (3 条)
     2. 若干斜线 (4 条)
     3. “V” 型、“倒 V” 型等 (2 条)

3. 符号集合（示例）
   - 普通符号：
     - 🍎 苹果（低赔）
     - 🍊 橙子
     - 🍉 西瓜
     - 🍇 葡萄
   - 中高赔符号：
     - 🔔 铃铛
     - ⭐ 星星
   - 高赔符号：
     - 🔥 数字 7
     - BAR（单 BAR / 双 BAR / 三 BAR）

### 3.2 赔率表（Paytable）

- 示例（3 个连续相同符号中奖）：
  - 3 × 苹果：2 倍
  - 3 × 橙子：3 倍
  - 3 × 西瓜：5 倍
  - 3 × 铃铛：10 倍
  - 3 × 星星：20 倍
  - 3 × 7：50 倍
- 下注额计算：
  - **单线获奖金币 = 单线下注额 × 对应赔率**
  - **总赢得金币 = 所有中奖线的获奖金币之和**

> 设计要求：  
> - 支持通过配置文件 / 数据库修改赔率表。  
> - 后端统一从配置中读取赔率，而不是写死在代码里。

### 3.3 随机与公平

1. 随机源
   - 使用 Node.js 自带的 `crypto.randomInt` 或第三方加密安全随机库。
   - 禁止使用 `Math.random()` 作为唯一 RNG 源（可用于前端动画，但后端结果必须使用更安全随机）。

2. 抽样逻辑
   - 为每个转轴定义一个 **符号池数组**，根据权重多次重复符号，使用随机索引选择结果。
   - 或用加权随机算法（累计权重区间二分查找）。

3. 回报率（RTP）调试（非严格赌场级）
   - 设置默认 RTP 区间，例如：90% ~ 95%（娱乐游戏可适当偏高，避免玩家亏得太快）。
   - 在测试环境跑大量模拟局统计：
     - `总返奖 / 总下注 ≈ RTP`
   - 审核结果后，调整符号权重与赔率表。

> 重要：  
> - 不能在生产环境中动态改变玩家个人胜率（避免“黑箱控水”）。  
> - 所有玩家使用统一算法，确保公平。

---

## 4. 系统架构设计

### 4.1 总体结构

- **前端**（浏览器）：
  - UI 展示、动画、用户输入。
  - 通过 HTTP / WebSocket 调用后端接口。
- **后端（Node.js）**：
  - 提供 API：
    - 登录 / 注册
    - 获取用户信息（余额、历史记录）
    - 发起一次 Spin（转动）
    - 获取配置（赔率表、线型等）
  - 管理逻辑：
    - 处理下注逻辑与结算。
    - 做好并发保护，避免重复扣款。

- **数据库**：  
  - 推荐 PostgreSQL / MySQL / MongoDB 等
  - 存储用户、账户余额、历史游戏记录、配置参数。

### 4.2 模块划分（后端）

1. **用户模块**
   - 负责：
     - 用户注册登录。
     - 加密存储密码（如 bcrypt）。
     - 读取 / 更新金币余额。

2. **游戏引擎模块（核心）**
   - 输入：
     - 当前用户 ID
     - 下注总额 / 单线下注额
     - 线数、盘面配置
   - 输出：
     - 本局生成的 **盘面结果**（符号矩阵）
     - 中奖线列表
     - 总赢得金币
   - 内部职责：
     - 校验用户余额是否足够。
     - 生成随机盘面。
     - 根据赔率 & 线型计算奖励。
     - 原子更新用户余额。

---

## 7. 游戏流程（逻辑时序）

1. **玩家登录**
   - 前端获取用户登录信息。

2. **进入游戏界面**
   - 前端页面 /app/game/pingguoji/page.tsx

3. **玩家设置下注参数**
   - 调整单线下注金额、选择线数。
   - 前端本地校验：下注额不能超过当前余额。

4. **点击 “Spin”**
   - 前端将设置参数发送到 `/api/game/spin`。
   - 按钮暂时禁用，避免重复点击。



6. **返回结果**
   - 前端收到 JSON：
     - 新余额。
     - 盘面结果。
     - 中奖线与奖金。
   - 前端播放转动动画 & 中奖特效。
   - 恢复 Spin 按钮状态。

---

## 8. 配置与可扩展性要求

1. **可配置的符号与权重**
   - 不把符号名称、权重写死在代码中。
   - 支持后台从数据库修改并热更新（例如重启服务或定时刷新）。

2. **多机房 / 多实例一致性**
   - 配置从统一源读取（数据库 / 配置服务）。
   - 可能使用缓存（Redis）提升性能。

3. **功能扩展**
   - 增加免费游戏（Free Spin）模式。
   - 增加 Bonus Game（小游戏，比如选箱子）—— 通过盘面特殊组合触发。
   - 增加任务或签到系统，赠送虚拟金币。

---

## 9. 编程与开发规范（Node.js 部分）

### 9.1 代码规范要求

1. 使用 TypeScript（推荐，但非必需）：
   - 清晰的类型定义用于配置结构、响应格式。
2. 统一错误处理：
   - 统一返回格式 `{ code, message, data }`。
3. 安全要求：
   - 密码哈希（如 bcrypt）。
   - Token 认证（如 JWT），设置合理的过期时间。
   - 防止接口被刷（可加简单 rate limit）。
4. 随机公平性：
   - 所有真实结算只使用后端 RNG。
   - 前端展示结果必须与后端返回的数据完全一致，不允许“伪随机动画”。

