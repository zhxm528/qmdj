# 注册邮箱确认流程设计说明
本文以“用户注册 + 邮箱确认”的典型流程为背景，说明在产品与数据结构层面如何设计。
## 整体流程概览
- 用户在注册页：app/register/page.tsx ； 填写内容：邮箱 + 密码（及其他必要信息）。
- 系统创建一条“未验证邮箱”的用户记录，并生成一条“邮箱确认记录”（带有随机 Token、有效期）。
- 系统向用户邮箱发送一封确认邮件，邮件中包含“确认邮箱”的链接。
- 用户打开邮箱，点击确认链接。
- 系统校验链接有效性：
 - 如果合法且未过期：将用户标记为“邮箱已验证”，并引导用户完成登录/后续信息。
 - 如果无效或过期：提示错误信息，并提供“重新发送确认邮件”的入口。

## 用户数据结构设计
- 统一存入同一个用户表，用字段区分邮箱是否已验证
- 用户表： md/database/users.sql

## 邮件内容设计
### 邮件主题（Subject）
- 简洁直观，告知用户需要执行的动作：
- 示例：
 - 请确认您的邮箱以完成注册
 - 【奇门遁甲】邮箱验证：点击确认，激活您的账户
### 发件人信息
- 发件人名称：如“奇门遁甲”，给用户安全感。
- 发件邮箱地址：使用统一官方域名，如 zhxm528@126.com。
### 邮件正文结构
- 正文建议包含以下部分（示例文案为中文，可根据产品风格调整）：
#### 称呼与感谢
- 例：「您好，感谢注册【奇门遁甲】！」
#### 邮箱验证说明
- 简短说明：“为了确认这是您的邮箱地址，请在 [有效期说明，如 24 小时内] 点击下方按钮完成验证。”
#### 主要行动按钮/链接
- 一个显眼的“确认邮箱”按钮（HTML 邮件）+ 文本形式的备用链接。
- 链接为邮箱验证 URL（见下一节）。
#### 有效期与安全提示
- 告知链接有效期：“此链接将在 24 小时后失效。”
- 告知如果不是本人操作：“如果这不是您本人的操作，请忽略本邮件，您的账号不会被激活。”
#### 次要信息
- 如帮助中心链接、联系客服方式等：“如有任何疑问，请联系：support@example.com”
- 邮件可在末尾加上品牌信息与版权声明。

## 邮箱确认链接设计
### 链接形式
#### 建议形式（示意）：
http://localhost:3000/verify-email?token=随机字符串
或
https://example.com/verify-email?uid=用户ID&token=随机字符串

#### 设计原则：
- 链接应为 HTTPS，防止被窃听或篡改。
- 参数不要包含敏感明文信息（如明文密码、完整身份证号等）。
- Token 为一次性使用：验证成功后立即标记为已用。
- 设置明确有效期（如 24 小时），验证时要做校验。

### Token 设计要点
- 足够长、随机、不可预测。
- 与具体用户绑定，即验证时必须同时校验 user_id 和 token 是否匹配（如果 URL 中包含 uid）。
- 支持多次发送邮件：新邮件生成新 token，旧 token 设为失效或保持单独状态。

## 用户点击确认链接后，系统的行为设计
点击链接后，系统的逻辑可分为以下几步：
### 验证链接合法性
系统接收到请求后，需要完成以下校验：
#### 检查 token 是否存在。
- 在邮箱验证表中根据 token（及 uid）查找对应记录。
- 如不存在：提示“链接无效或已失效”。
#### 检查 token 状态
- 如果 status != "pending" 或 used_at 非空：说明该链接已使用或失效。
- 返回“链接已被使用或已失效”，并给出重新发送验证邮件的入口。
#### 检查是否已过期
- 比较当前时间与 expires_at。
- 如果已过期：提示“链接已过期”，并给出按钮“重新发送确认邮件”。
#### 检查邮箱是否与用户一致
- 根据 user_id 查找用户表中的记录。
- 对比验证记录中的 email 与用户当前邮箱，避免用户改过邮箱后旧链接仍然可用。
### 若验证成功，更新系统状态
当所有校验通过时，系统应执行：
#### 在邮箱验证表中：
- 将 status 标记为 used。
- 写入 used_at 当前时间。
#### 在用户表中：
- 将 is_email_verified 设置为 true。
- 如果之前 status = "pending"，此刻可切换为 active。
- 根据产品需求，若允许“验证后自动登录”，可更新登录状态相关字段。
#### 记录日志（内部）：
- 记录用户 ID、IP、时间等信息，用于安全审计。
### 前端页面反馈
- 验证完成后，向用户展示合适的页面：
#### 成功场景：
- 展示“邮箱验证成功”的明确提示。
- 提供下一步动作：
 - “进入首页”
 - “完善个人资料”
 - “立即开始使用” 等按钮。
#### 失败/过期场景：
- 明确提示原因：“链接已失效，请重新发送确认邮件。”
- 提供“重新发送确认邮件”的按钮：用户点击后，系统重新创建一个新的验证记录并发送新邮件（同时对发送频率做限制）。

## lib/目录下和api/目录下的程序设计原则和职责分工：
- 用户表 / 验证表的读写逻辑 → lib/db、lib/user、lib/emailVerification
- 发送确认邮件的具体实现 → lib/mailer
- “注册接口”“点击确认链接接口” → api/register、api/verify-email
